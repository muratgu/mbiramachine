<html>
<head>
<script src="static/js/jquery.min.js"></script>
<script src="tone.js"></script>
<script src="mbira-tone.js"></script>
<script>
$(function () {
    var TAG = 'Page'
    var DEBUG = true

    var log = function (s) { if(DEBUG && console && console.log) console.log(s) }
    var error = function (s, e) { if (console && console.log) console.log(s); console.log(e) }

    var mbiraTone
    var selectedKitName
    var selectedTabName
    var selectedTempo = '8n'

    /* EVENT HANDLERS */
    var onMbiraKitSelected = function(name) {
        selectedKitName = name
        onMbiraLoadClicked()
    }
    var onMbiraTabSelected = function(name) {
        selectedTabName = name
        onMbiraLoadClicked()
    }
    var onMbiraStartClicked = function () {
        if (mbiraTone) mbiraTone.start()
        $('#mbira-start').prop('disabled', true);
        $('#mbira-stop').prop('disabled', false);
    }
    var onMbiraStopClicked = function () {
        if (mbiraTone) mbiraTone.stop()
        $('#mbira-start').prop('disabled', false);
        $('#mbira-stop').prop('disabled', true);
    }
    var onMbiraLoadClicked = function () {
        onMbiraStopClicked()
        onMbiraLoading()
        if (mbiraTone) {
            mbiraTone.load({
                kitName: selectedKitName,
                tabName: selectedTabName,
                tempo: selectedTempo,
                onKeysPlayed: onKeysPlayed
            }, function(){
                // ready to play
                onMbiraLoaded()
            })
        }
    }
    var onMbiraLoading = function () {
        $('#mbira-start').prop('disabled', true);
        $('#mbira-stop').prop('disabled', true);
    }
    var onMbiraLoaded = function () {
        $('#mbira-start').prop('disabled', false);
        $('#mbira-stop').prop('disabled', true);
    }
    var onKeysPlayed = function(keys) {
        log(keys)
    }

    /* SETUP */
    var bindEvents = function() {
        $('#mbira-start').on('click', function(ev){ onMbiraStartClicked() })
        $('#mbira-stop').on('click', function(ev){ onMbiraStopClicked() })
        $('#mbira-tabs').change(function(ev) { onMbiraTabSelected($(this).val()) });
        $('#mbira-kits').change(function(ev) { onMbiraKitSelected($(this).val()) });
        $('#mbira-tabs').prop('disabled', false)
        $('#mbira-kits').prop('disabled', false)
    }
    var loadOptions = function(){
        mbiraTone.getKitNames().forEach(x=> {
            $('#mbira-kits').append($("<option />").val(x).text(x));
        })
        mbiraTone.getTabNames().forEach(x=> {
            $('#mbira-tabs').append($("<option />").val(x).text(x));
        })
    }
    var showLoading = function() {
        $('.content').hide()
        $('.preloader').show()
    }
    var hideLoading = function() {
        $('.preloader').fadeOut("slow")
        $('.content').show()
    }
    var initalize = function () {
        showLoading()
        mbiraTone = MbiraTone(function() {
            loadOptions()
            bindEvents()
            log(TAG+': mbiraTone: ready')
            hideLoading()
        })
    }

    initalize()
})
</script>
<link href="style/tone.css" rel="stylesheet">
</head>
<body>
    <div class='preloader'></div>
    <div id='content'>
        <div class='selector'>
            <span>Tuning</span>
            <select id='mbira-kits' disabled='disabled'/>
                <option name='select'>Select</option>
            </select>
        </div>
        <div class='selector'>
            <span>Piece</span>
            <select id='mbira-tabs' disabled='disabled'/>
                <option name='select'>Select</option>
            </select>
        </div>
        <div id='mbira-controls'>
            <input id='mbira-start' type='submit' value='Start' disabled='disabled'/>
            <input id='mbira-stop' type='submit' value='Stop' disabled='disabled'/>
        </div>
        <canvas id='mbira-instrument' width='800' height='600'>
        </canvas>
    <div>
    <script>
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      var canvas = document.getElementById('mbira-instrument');
      var context = canvas.getContext('2d');

      canvas.addEventListener('mouseup', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        var message = Math.trunc(mousePos.x) + ' ' + Math.trunc(mousePos.y);
        console.log(message);
      }, false);
    </script>
</body>
</html>
