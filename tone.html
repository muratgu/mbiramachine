<html>
<head>
<script src="static/js/jquery.min.js"></script>
<script src="tone.js"></script>
<script src="mbira-tone.js"></script>
<script>
$(function () {
    var TAG = 'Page'
    var DEBUG = false

    var log = function (s) { if(DEBUG && console && console.log) console.log(s) }
    var error = function (s, e) { if (console && console.log) console.log(s); console.log(e) }

    var mbiraTone
    var selectedKitId
    var selectedTabId
    var selectedBpm = 60
    var selectedTempo = '8n'

    /* EVENT HANDLERS */
    var handleMbiraKitSelected = function(id) {
        selectedKitId = id
        handleMbiraLoad()
    }
    var handleMbiraTabSelected = function(id) {
        selectedTabId = id
        handleMbiraLoad()
    }
    var handleMbiraBpmSelected = function(id) {
        selectedBpm = id
        if (mbiraTone) {
            mbiraTone.setBpm(selectedBpm)
        }
    }
    var handleMbiraStart = function () {
        handleMbiraLoad()
        measureCounter = 0
        if (mbiraTone) mbiraTone.start()
        $('#mbira-start').prop('disabled', true);
        $('#mbira-stop').prop('disabled', false);
    }
    var handleMbiraStop= function () {
        if (mbiraTone) mbiraTone.stop()
        $('#mbira-start').prop('disabled', false);
        $('#mbira-stop').prop('disabled', true);
        $('#mbira-time').html('')
    }
    var handleMbiraLoad = function () {
        handleMbiraStop()
        handleMbiraLoading()
        if (mbiraTone) {
            mbiraTone.load({
                kitId: selectedKitId,
                tabId: selectedTabId,
                bpm: selectedBpm,
                tempo: selectedTempo,
                onKeysPlayedCallback: handleKeysPlayed,
                onMeasureCallback: handleMeasure,
            }, function(){
                // ready to play
                handleMbiraLoaded()
            })
        }
    }
    var handleMbiraLoading = function () {
        $('#mbira-start').prop('disabled', true);
        $('#mbira-stop').prop('disabled', true);
    }
    var handleMbiraLoaded = function () {
        $('#mbira-start').prop('disabled', false);
        $('#mbira-stop').prop('disabled', true);
    }
    var handleKeysPlayed = function(keys) {
        log(keys)
    }
    var measureCounter = 0
    var handleMeasure = function(time) {
        if (measureCounter > 8) {
            $('#mbira-time').html('')
            return
        }
        var hoshoBeatCounter = measureCounter % 3 + 1
        var s = $('#mbira-time').html()
        $('#mbira-time').html(s+' '+hoshoBeatCounter)
        measureCounter += 1
    }

    /* SETUP */
    var bindEvents = function() {
        $('#mbira-start').on('click', function(ev){ handleMbiraStart() })
        $('#mbira-stop').on('click', function(ev){ handleMbiraStop() })
        $('#mbira-kits').change(function(ev) { handleMbiraKitSelected($(this).val()) });
        $('#mbira-tabs').change(function(ev) { handleMbiraTabSelected($(this).val()) });
        $('#mbira-bpm').change(function(ev) { handleMbiraBpmSelected($(this).val()) });
        $('#mbira-kits').prop('disabled', false)
        $('#mbira-tabs').prop('disabled', false)
        $('#mbira-bpm').prop('disabled', false)
    }
    var loadOptions = function(){
        mbiraTone.getKitList().forEach(x=> {
            $('#mbira-kits').append($("<option />").val(x.id).text(x.name));
        })
        mbiraTone.getTabList().forEach(x=> {
            $('#mbira-tabs').append($("<option />").val(x.id).text(x.name));
        })
        mbiraTone.getBpmList().forEach(x=> {            
            $('#mbira-bpm').append($("<option />").val(x.id).text(x.name));
        })
    }
    var showLoading = function() {
        $('.content').hide()
        $('.preloader').show()
    }
    var hideLoading = function() {
        $('.preloader').fadeOut("slow")
        $('.content').show()
    }
    var initalize = function () {
        showLoading()
        mbiraTone = MbiraTone(function() {
            loadOptions()
            bindEvents()
            log(TAG+': mbiraTone: ready')
            hideLoading()
        })
    }

    initalize()
})
</script>
<link href="style/tone.css" rel="stylesheet">
</head>
<body>
    <div class='preloader'></div>
    <div id='content'>
        <div class='selector'>
            <span>Tuning</span>
            <select id='mbira-kits' disabled='disabled'/>
                <option name='select'>Select</option>
            </select>
        </div>
        <div class='selector'>
            <span>Piece</span>
            <select id='mbira-tabs' disabled='disabled'/>
                <option name='select'>Select</option>
            </select>
        </div>
        <div class='selector'>
            <span>Bpm</span>
            <select id='mbira-bpm' disabled='disabled'/>
                <option name='select'>Select</option>
            </select>            
        </div>
        <div id='mbira-controls'>
            <input id='mbira-start' type='submit' value='Start' disabled='disabled'/>
            <input id='mbira-stop' type='submit' value='Stop' disabled='disabled'/>
            <span id='mbira-time'></span>
        </div>
        <canvas id='mbira-instrument' width='800' height='600'>
        </canvas>
    <div>
    <script>
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      var canvas = document.getElementById('mbira-instrument');
      var context = canvas.getContext('2d');

      canvas.addEventListener('mouseup', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        var message = Math.trunc(mousePos.x) + ' ' + Math.trunc(mousePos.y);
        console.log(message);
      }, false);
    </script>
</body>
</html>
