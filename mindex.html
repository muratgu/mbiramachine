<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="Create custom drum beats with a few clicks.  Choose from 15 drum kits and 26 effects, and adjust the pitch of each drum.  Save and share your beatsâ€¦ rock on!">
<title>WebAudio Mbira Machine</title>

<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Michroma">
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid Sans">
<link rel="stylesheet" type="text/css" href = "style/mbiramachine.css" />


<!-- Our javascript code -->
<script type="text/javascript">

// Events
// init() once the page has finished loading.

// Temporary patch until all browsers support unprefixed context.
if (window.hasOwnProperty('AudioContext') && !window.hasOwnProperty('webkitAudioContext'))
    window.webkitAudioContext = AudioContext;

window.onload = init;

var context;
var convolver;
var compressor;
var masterGainNode;
var effectLevelNode;

// Each effect impulse response has a specific overall desired dry and wet volume.
// For example in the telephone filter, it's necessary to make the dry volume 0 to correctly hear the effect.
var effectDryMix = 1.0;
var effectWetMix = 1.0;

var timeoutId;

var startTime;
var lastDrawTime = -1;

var kits;

var instruments = ['X', 'B1','B2','B3','B4','B5','B6','B7','B8','R1','R2','R3','R4','R5','R6','R7','R8','R9','R10','R11','L1','L2','L3','L4','L5','L6','L7','L8']

var kNumInstruments = instruments.length;
var kInitialKitIndex = 0;
var kMaxSwing = .08;

var currentKit;

var beatReset = {"name": "blank", "rhythm":new Array(48)};

var beatDemo = [
        {"name": "nhemamusasa kushaura", 
         "rhythm":
            [
            'L3','R2','B3 X','R5','L4','R2','B5 X','R4','L4','R3','B7 X','R5',
            'L3','R2','B3 X','R5','L5','R3','B6 X','R5','L4','R3','B7 X','R6',
            'L2','R3','B4 X','R6','L5','R3','B6 X','R5','L4','R3','B7 X','R5',
            'L3','R2','B3 X','R5','L4','R2','B5 X','R4','L2','R2','L1 X','R5'
            ]
        },
        {"name": "karigamombe kushaura",
         "rhythm":
            [
            'R2 L1','R6','R2 L2','R6','R1 L5','R4','R1 L5','R4','R1 L4','R4','R1 L4','R4',
            'R2 L1','R6','R2 L2','R6','R2 L3','R5','R2 L3','R5','R1 L4','R4','R1 L4','R4',
            'R3 L4','R5','R3 L4','R5','R2 L3','R5','R2 L3','R5','R1 L4','R4','R1 L4','R4',
            'R2 L1','R6','R2 L2','R6','R1 L5','R4','R1 L5','R4','R3 L2','R6','R3 L2','R6'
            ]
        },
        {"name": "karigamombe kutsanhira",
         "rhythm":
            [
            'R2','L1','R6 B1','','R4 R1 B6','L2','R4 R1','L1','R7 B5'   ,'','R7 L1','L5',
            'R2','L1','R6 B4','','R5 B6'   ,'B5','R5'   ,'L1','R4 R1 B2','','R4 R1','B2',
            'R3','B5','R3 B1','','R5 B6'   ,'B5','R5'   ,'L1','R4 R1 B2','','R4 R1','B2',
            'R2','B4','R2 B1','','R4 R1 B6','B2','R4 R1','B6','R3 B4'   ,'','R3 B7','B4'
            ]
        },
        {"name": "nyamaropa kushaura",
         "rhythm":
            [
            'R2 L1','B1','R2','L1','R2 B1','','R4 L5','B2','R4','L2','R3 B4', '',
            'R2 L1','B1','R2','L1','R2 B1','','R4 L5','B2','R2','L4','R4 B5', '',
            'R2 L1','B1','R2','L1','R2 B1','','R5 L3','B3','R5','L4','R4 B5', '',
             'R3 L4','B7','R3','L4','R3 B7','','R5 L3','B3','R5','L4','R4 B5', ''
            ]
        },
        {"name": "kuzanga variation 5",
         "rhythm":
            [
            'R5 L3','B3','R5','L4','R2 B5','R4','L4','R3 B1','',
            'R5 L3','B3','R5','L5','R3 B6','R5','L4','R3 B1','',
            'R6 L2','B4','R6','L5','R3 B6','R6','L2','R2 B1','',
            'R4 L2','B4','R4','L4','R2 B5','R4','L2','R2 B1',''
            ]
        },
        {"name": "marenje kutsinhira",
         "rhythm":
            [
            '','R4 R1 L4','B5','R4','L1','R2 B2','','R4 R1 L4','B5','R4'   ,'L1','R2    B3', 
            '','R4 R1 L4','B5','R4','L4','R3 B1','','R3    L4','B5','R3'   ,'L1','R2    B3', 
            '','R3    L5','B6','R3','L5','R3 B1','','R4    L4','B5','R3'   ,'L1','R2    B3', 
            '','R4 R1 L4','B5','R4','L1','R2 B2','','R4 R1 L5','B6','R4 R1','L5','R4 R1 B2', 
            ]
        },         
    ]

function cloneBeat(source) {
    var beat = new Object();
    
    beat.name = source.name
    beat.effectIndex = 0
    beat.tempo = 80
    beat.swingFactor = 0
    beat.effectMix = 0
    beat.pitchVal = 1
    beat.rhythm = source.rhythm.slice(0);        // slice(0) is an easy way to copy the full array
    
    return beat;
}

// theBeat is the object representing the current beat/groove
// ... it is saved/loaded via JSON
var theBeat = cloneBeat(beatReset);

var mouseCapture = null;
var mouseCaptureOffset = 0;

var soundLoopLength = 48;
var displayLoopLength = 12;
var rhythmIndex = 0;
var kMinTempo = 50;
var kMaxTempo = 180;
var noteTime = 0.0;

var volumes = [0, 0.3, 1];

var kitCount = 0;

var kitName = [
    "nyamaropa_b",
    "dambatsoko",
    "gandanga"
    ];

var kitNamePretty = [
    "Nyamaropa B",
    "Dambatsoko",
    "Gandanga"
    ];

function Kit(name) {
    this.name = name;

    this.buffer = [];

    this.instrumentCount = kNumInstruments;
    this.instrumentLoadCount = 0;
    
    this.startedLoading = false;
    this.isLoaded = false;
    
    this.beat = undefined
    this.panX = 0;
}

Kit.prototype.setBeat = function(beat) {
    this.beat = cloneBeat(beat)
}

Kit.prototype.load = function() {
    if (this.startedLoading)
        return;
        
    this.startedLoading = true;
        
    var pathName = "sounds/" 

    for(var i in instruments) {
        this.loadSample(instruments[i], pathName)  
    }
}

Kit.prototype.loadSample = function(instrumentID, pathName) {
    // Load asynchronously
    var url = pathName + this.name + '_' + instrumentID + '.mp3'    
    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    var kit = this;

    request.onload = function() {
        context.decodeAudioData(
            request.response,
            function(buffer) {
                kit.buffer[instrumentID] = buffer
                kit.instrumentLoadCount++;
                if (kit.instrumentLoadCount == kit.instrumentCount) {
                    kit.isLoaded = true;
                }
            },
            
            function(err) {
                kit.instrumentLoadCount++;
                console.log(kit.name + ' ' + sampleID + ' not loaded')
                if (kit.instrumentLoadCount == kit.instrumentCount) {
                    kit.isLoaded = true;
                }
            }
        );
    }

    request.send();
}

var impulseResponseInfoList = [
    // Impulse responses - each one represents a unique linear effect.
    {"name":"Medium Hall 1",    "url":"impulse-responses/matrix-reverb2.wav",   "dryMix":1, "wetMix":1  },
    {"name":"Medium Hall 2",    "url":"impulse-responses/matrix-reverb3.wav",   "dryMix":1, "wetMix":1  },
    {"name":"Binaural Hall",    "url":"impulse-responses/s2_r4_bd.wav",         "dryMix":1, "wetMix":0.5},
    {"name":"Telephone Filter", "url":"impulse-responses/filter-telephone.wav", "dryMix":0, "wetMix":1.2},
]

var impulseResponseList = 0;

function ImpulseResponse(name, url, index) {
    this.url = url;
    this.index = index;
    this.name = name;
    this.startedLoading = false;
    this.isLoaded_ = false;
    this.buffer = 0;
    
    this.demoIndex = -1; // no demo
}

ImpulseResponse.prototype.setDemoIndex = function(index) {
    this.demoIndex = index;
}

ImpulseResponse.prototype.isLoaded = function() {
    return this.isLoaded_;
}

ImpulseResponse.prototype.load = function() {
    if (this.startedLoading) {
        return;
    }
    
    this.startedLoading = true;

    // Load asynchronously
    var request = new XMLHttpRequest();
    request.open("GET", this.url, true);
    request.responseType = "arraybuffer";
    this.request = request;
    
    var asset = this;

    request.onload = function() {
        context.decodeAudioData(
            request.response,
            function(buffer) {
                asset.buffer = buffer;
                asset.isLoaded_ = true;                               
            },
            
            function(err) {
                console.log(asset.name + ' not loaded')
                console.log("Error decoding impulse response!");
            }
        );
    }

    request.send();
}

function startLoadingAssets() {
    impulseResponseList = new Array();

    for (i = 0; i < impulseResponseInfoList.length; i++) {
        impulseResponseList[i] = new ImpulseResponse(impulseResponseInfoList[i].name, 
            impulseResponseInfoList[i].url, i);
    }
    
    // load mbira kits
    var numKits = kitName.length;
    kits = new Array(numKits);
    for (var i  = 0; i < numKits; i++) {
        kits[i] = new Kit(kitName[i]);
        kits[i].load()
    }  
    
    // load effects
    for (i = 0; i < impulseResponseInfoList.length; i++) {
        impulseResponseList[i].load();
    }

    // Setup initial mbira
    currentKit = kits[kInitialKitIndex];   

}

function showPlayAvailable() {
    var play = document.getElementById("play");
    play.src = "images/btn_play.png";
}

function init() {
    context = new webkitAudioContext();

    startLoadingAssets();
    
    var finalMixNode;
    if (context.createDynamicsCompressor) {
        // Create a dynamics compressor to sweeten the overall mix.
        compressor = context.createDynamicsCompressor();
        compressor.connect(context.destination);
        finalMixNode = compressor;
    } else {
        // No compressor available in this implementation.
        finalMixNode = context.destination;
    }

    // Create master volume.
    masterGainNode = context.createGain();
    masterGainNode.gain.value = 0.7; // reduce overall volume to avoid clipping
    masterGainNode.connect(finalMixNode);

    // Create effect volume.
    effectLevelNode = context.createGain();
    effectLevelNode.gain.value = 1.0; // effect level slider controls this
    effectLevelNode.connect(masterGainNode);

    // Create convolver for effect
    convolver = context.createConvolver();
    convolver.connect(effectLevelNode);

    var elBeatCombo = document.getElementById('beatcombo');
    elBeatCombo.addEventListener("mousedown", handleBeatComboMouseDown, true);

    var elKitCombo = document.getElementById('kitcombo');
    elKitCombo.addEventListener("mousedown", handleKitComboMouseDown, true);

    var elEffectCombo = document.getElementById('effectcombo');
    elEffectCombo.addEventListener("mousedown", handleEffectComboMouseDown, true);

    document.body.addEventListener("mousedown", handleBodyMouseDown, true);

    initControls();
    updateControls();
}

function initControls() {
    makeBeatList();
    makeKitList();
    makeEffectList();

    // sliders
    document.getElementById('effect_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('pitch_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('swing_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    

    document.getElementById('effect_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('pitch_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('swing_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    
    // tool buttons
    document.getElementById('play').addEventListener('mousedown', handlePlay, true);
    document.getElementById('stop').addEventListener('mousedown', handleStop, true);
    document.getElementById('save').addEventListener('mousedown', handleSave, true);
    document.getElementById('save_ok').addEventListener('mousedown', handleSaveOk, true);
    document.getElementById('load').addEventListener('mousedown', handleLoad, true);
    document.getElementById('load_ok').addEventListener('mousedown', handleLoadOk, true);
    document.getElementById('load_cancel').addEventListener('mousedown', handleLoadCancel, true);
    document.getElementById('reset').addEventListener('mousedown', handleReset, true);
    
    var elBody = document.getElementById('body');
    elBody.addEventListener('mousemove', handleMouseMove, true);
    elBody.addEventListener('mouseup', handleMouseUp, true);

    document.getElementById('tempoinc').addEventListener('mousedown', tempoIncrease, true);
    document.getElementById('tempodec').addEventListener('mousedown', tempoDecrease, true);
}

function makeBeatList() {
    var elList = document.getElementById('beatlist')
    var numBeats = beatDemo.length
    
    for (var i = 0; i < numBeats; i++) {
        var elItem = document.createElement('li')
        elItem.innerHTML = beatDemo[i].name
        elItem.id = 'beat-' + i
        elList.appendChild(elItem)
        elItem.addEventListener("mousedown", handleBeatMouseDown, true)
    }
}

function makeEffectList() {
    var elList = document.getElementById('effectlist')
    var numEffects = impulseResponseInfoList.length
    
    var elItem = document.createElement('li')
    elItem.innerHTML = 'None'
    elItem.addEventListener("mousedown", handleEffectMouseDown, true)
    
    for (var i = 0; i < numEffects; i++) {
        var elItem = document.createElement('li')
        elItem.innerHTML = impulseResponseInfoList[i].name
        elList.appendChild(elItem)
        elItem.addEventListener("mousedown", handleEffectMouseDown, true)
    }
}

function makeKitList() {
    var elList = document.getElementById('kitlist')
    var numKits = kitName.length
    
    for (var i = 0; i < numKits; i++) {
        var elItem = document.createElement('li')
        elItem.innerHTML = kitNamePretty[i]
        elList.appendChild(elItem)
        elItem.addEventListener("mousedown", handleKitMouseDown, true)
    }
}

Kit.prototype.advanceNote = function() {
    var secondsPerBeat = 60.0 / beat.tempo;

    rhythmIndex++;
    if (rhythmIndex == beat.rhythm.length) {
        rhythmIndex = 0;
    }

        // apply swing    
    if (rhythmIndex % 2) {
        noteTime += (0.25 + kMaxSwing * this.beat.swingFactor) * secondsPerBeat;
    } else {
        noteTime += (0.25 - kMaxSwing * this.beat.swingFactor) * secondsPerBeat;
    }
}

Kit.prototype.playNote = function(buffer, pan, x, y, z, sendGain, mainGain, playbackRate, noteTime) {
    // Create the note
    var voice = context.createBufferSource();
    voice.buffer = buffer;
    voice.playbackRate.value = playbackRate;

    // Optionally, connect to a panner
    var finalNode;
    if (pan) {
        var panner = context.createPanner();
        panner.setPosition(x, y, z);
        voice.connect(panner);
        finalNode = panner;
    } else {
        finalNode = voice;
    }

    // Connect to dry mix
    var dryGainNode = context.createGain();
    dryGainNode.gain.value = mainGain * effectDryMix;
    finalNode.connect(dryGainNode);
    dryGainNode.connect(masterGainNode);

    // Connect to wet mix
    var wetGainNode = context.createGain();
    wetGainNode.gain.value = sendGain;
    finalNode.connect(wetGainNode);
    wetGainNode.connect(convolver);

    voice.start(noteTime);
}

Kit.prototype.schedule = function() {
    var currentTime = context.currentTime;

    // The sequence starts at startTime, so normalize currentTime so that it's 0 at the start of the sequence.
    currentTime -= startTime;

    while (noteTime < currentTime + 0.200) {
        // Convert noteTime to context time.
        var contextPlayTime = noteTime + startTime;
        var currentRhythmCode = theBeat.rhythm[rhythmIndex].split(' ')
        for(var c in currentRhythmCode) {
            if(currentRhythmCode[c] > '') {
                var playBuffer = currentKit.buffer[currentRhythmCode[c]]
                if(playBuffer) {
                    this.playNote(playBuffer, false, 0,0,-2, 0.5, 1.0, this.beat.pitchVal, contextPlayTime);
                }
            }
        }
        
        // Attempt to synchronize drawing time with sound
        if (noteTime != lastDrawTime) {
            lastDrawTime = noteTime;
            drawPlayhead((rhythmIndex + soundLoopLength - 1) % displayLoopLength);
        }

        this.advanceNote();
    }

    timeoutId = setTimeout( function() {
        this.schedule()
    }, 0 );
}

function tempoIncrease() {
    theBeat.tempo = Math.min(kMaxTempo, theBeat.tempo+4);
    document.getElementById('tempo').innerHTML = theBeat.tempo;
}

function tempoDecrease() {
    theBeat.tempo = Math.max(kMinTempo, theBeat.tempo-4);
    document.getElementById('tempo').innerHTML = theBeat.tempo;
}

function handleSliderMouseDown(event) {
    mouseCapture = event.target.id;
    var thumbY = 0;    
    do {
        thumbY += el.offsetTop;
    } while (el = el.offsetParent);

    mouseCaptureOffset = event.pageY - thumbY;
}

function handleSliderDoubleClick(event) {
    var id = event.target.id;
    if (id == 'effect_thumb') {
        mouseCapture = null;
        sliderSetValue(id, 1.0);
        updateControls();
    } else if (id == 'pitch_thumb') {
        mouseCapture = null;
        sliderSetValue(id, 1.0);
        updateControls();
    } else if (id == 'swing_thumb') {
        mouseCapture = null;
        sliderSetValue(id, 0.0);
        updateControls();
    }
}

function handleMouseMove(event) {
    if (!mouseCapture) return;
    
    var elThumb = document.getElementById(mouseCapture);
    var elTrack = elThumb.parentNode;

    var thumbH = elThumb.clientHeight;
    var trackH = elTrack.clientHeight;
    var travelH = trackH - thumbH;

    var trackY = 0;
    var el = elTrack;
    do {
        trackY += el.offsetTop;
    } while (el = el.offsetParent);

    var offsetY = Math.max(0, Math.min(travelH, event.pageY - mouseCaptureOffset - trackY));
    var value = 1.0 - offsetY / travelH;
    elThumb.style.top = travelH * (1.0 - value) + 'px';

    sliderSetValue(mouseCapture, value);
}

function handleMouseUp() {
    mouseCapture = null;
}

function sliderSetValue(slider, value) {
    var pitchRate = Math.pow(2.0, 2.0 * (value - 0.5));
    
    switch(slider) {
    case 'effect_thumb':
        theBeat.effectMix = value;
        setEffectLevel(theBeat);            
        break;    
    case 'swing_thumb':
        theBeat.swingFactor = value;
        break; 
    case 'pitch_thumb':
        theBeat.pitchVal = value;
        break;     
    }
}

function sliderSetPosition(slider, value) {
    var elThumb = document.getElementById(slider);
    var elTrack = elThumb.parentNode;
    
    var thumbH = elThumb.clientHeight;
    var trackH = elTrack.clientHeight;
    var travelH = trackH - thumbH;

    elThumb.style.top = travelH * (1.0 - value) + 'px';    
}

function handleBeatComboMouseDown(event) {
    if (event.target.id != 'beatlist') {
        document.getElementById('beatcombo').classList.toggle('active');
    }
}

function handleBeatMouseDown(event) {
    var index = event.target.id.split('-')[1]
    loadBeat(beatDemo[index]);
    document.getElementById('beatname').innerHTML = beatDemo[index].name;
}

function handleKitComboMouseDown(event) {
    document.getElementById('kitcombo').classList.toggle('active');
}

function handleKitMouseDown(event) {
    var index = kitNamePretty.indexOf(event.target.innerHTML);
    theBeat.kitIndex = index;
    currentKit = kits[index];
    document.getElementById('kitname').innerHTML = kitNamePretty[index];
}

function handleBodyMouseDown(event) {
    var elBeatcombo = document.getElementById('beatcombo');
    var elKitcombo = document.getElementById('kitcombo');
    var elEffectcombo = document.getElementById('effectcombo');

    if (elBeatcombo.classList.contains('active') && !isDescendantOfId(event.target, 'beatcombo_container')) {
        elBeatcombo.classList.remove('active');
        if (!isDescendantOfId(event.target, 'kitcombo_container')) {
            event.stopPropagation();
        }
    }

    if (elKitcombo.classList.contains('active') && !isDescendantOfId(event.target, 'kitcombo_container')) {
        elKitcombo.classList.remove('active');
        if (!isDescendantOfId(event.target, 'effectcombo_container')) {
            event.stopPropagation();
        }
    }
    
    if (elEffectcombo.classList.contains('active') && !isDescendantOfId(event.target, 'effectcombo')) {
        elEffectcombo.classList.remove('active');
        if (!isDescendantOfId(event.target, 'kitcombo_container')) {
            event.stopPropagation();
        }
    }    
}

function isDescendantOfId(el, id) {
    if (el.parentElement) {
        if (el.parentElement.id == id) {
            return true;
        } else {
            return isDescendantOfId(el.parentElement, id);
        }
    } else {
        return false;
    }
}

function handleEffectComboMouseDown(event) {
    if (event.target.id != 'effectlist') {
        document.getElementById('effectcombo').classList.toggle('active');
    }
}

function handleEffectMouseDown(event) {
    for (var i = 0; i < impulseResponseInfoList.length; ++i) {
        if (impulseResponseInfoList[i].name == event.target.innerHTML) {

            // Hack - if effect is turned all the way down - turn up effect slider.
            // ... since they just explicitly chose an effect from the list.
            if (theBeat.effectMix == 0)
                theBeat.effectMix = 0.5;

            setEffect(i);
            break;
        }
    }
}

function setEffect(index) {
    if (index > 0 && !impulseResponseList[index].isLoaded()) {
        alert('Sorry, this effect is still loading.  Try again in a few seconds :)');
        return;
    }

    theBeat.effectIndex = index;
    effectDryMix = impulseResponseInfoList[index].dryMix;
    effectWetMix = impulseResponseInfoList[index].wetMix;            
    convolver.buffer = impulseResponseList[index].buffer;

  // Hack - if the effect is meant to be entirely wet (not unprocessed signal)
  // then put the effect level all the way up.
    if (effectDryMix == 0)
        theBeat.effectMix = 1;

    setEffectLevel(theBeat);
    sliderSetValue('effect_thumb', theBeat.effectMix);
    updateControls();

    document.getElementById('effectname').innerHTML = impulseResponseInfoList[index].name;
}

function setEffectLevel() {        
    // Factor in both the preset's effect level and the blending level (effectWetMix) stored in the effect itself.
    effectLevelNode.gain.value = theBeat.effectMix * effectWetMix;
}

function handlePlay(event) {
    noteTime = 0.0;
    startTime = context.currentTime + 0.005;
    schedule();

    document.getElementById('play').classList.add('playing');
    document.getElementById('stop').classList.add('playing');
}

function handleStop(event) {
    clearTimeout(timeoutId);

    var elOld = document.getElementById('LED_' + (rhythmIndex + soundLoopLength - 2) % displayLoopLength);
    elOld.src = 'images/LED_off.png';

    rhythmIndex = 0;

    document.getElementById('play').classList.remove('playing');
    document.getElementById('stop').classList.remove('playing');
}

function handleSave(event) {
    toggleSaveContainer();
    var elTextarea = document.getElementById('save_textarea');
    elTextarea.value = JSON.stringify(theBeat);
}

function handleSaveOk(event) {
    toggleSaveContainer();
}

function handleLoad(event) {
    toggleLoadContainer();
}

function handleLoadOk(event) {
    var elTextarea = document.getElementById('load_textarea');
    theBeat = JSON.parse(elTextarea.value);

    // Set drumkit
    currentKit = kits[theBeat.kitIndex];
    document.getElementById('kitname').innerHTML = kitNamePretty[theBeat.kitIndex];

    // Set effect
    setEffect(theBeat.effectIndex);

    // Change the volume of the convolution effect.
    setEffectLevel(theBeat);

    // Apply values from sliders
    sliderSetValue('swing_thumb', theBeat.swingFactor);
    sliderSetValue('effect_thumb', theBeat.effectMix);
    sliderSetValue('pitch_thumb', theBeat.pitchVal);    

    // Clear out the text area post-processing
    elTextarea.value = '';

    toggleLoadContainer();
    updateControls();
}

function handleLoadCancel(event) {
    toggleLoadContainer();
}

function toggleSaveContainer() {
    document.getElementById('pad').classList.toggle('active');
    document.getElementById('params').classList.toggle('active');
    document.getElementById('tools').classList.toggle('active');
    document.getElementById('save_container').classList.toggle('active');
}

function toggleLoadContainer() {
    document.getElementById('pad').classList.toggle('active');
    document.getElementById('params').classList.toggle('active');
    document.getElementById('tools').classList.toggle('active');
    document.getElementById('load_container').classList.toggle('active');
}

function handleReset(event) {
    handleStop();
    loadBeat(beatReset);    
}

function loadBeat(beat) {
    handleStop();

    theBeat = cloneBeat(beat);
    soundLoopLength = theBeat.rhythm.length

    currentKit = kits[theBeat.kitIndex];
    setEffect(theBeat.effectIndex);

    // apply values from sliders
    sliderSetValue('swing_thumb', theBeat.swingFactor);
    sliderSetValue('effect_thumb', theBeat.effectMix);
    sliderSetValue('pitch_thumb', theBeat.pitchVal);
    
    updateControls();

    return true;
}

function updateControls() {    
    document.getElementById('kitname').innerHTML = kitNamePretty[theBeat.kitIndex];
    document.getElementById('effectname').innerHTML = impulseResponseInfoList[theBeat.effectIndex].name;
    document.getElementById('tempo').innerHTML = theBeat.tempo;
    sliderSetPosition('swing_thumb', theBeat.swingFactor);
    sliderSetPosition('effect_thumb', theBeat.effectMix);
    sliderSetPosition('pitch_thumb', theBeat.pitchVal);
}


function drawNote(draw, xindex, yindex) {    
    var elButton = document.getElementById(instruments[yindex] + '_' + xindex);
    switch (draw) {
        case 0: elButton.src = 'images/button_off.png'; break;
        case 1: elButton.src = 'images/button_half.png'; break;
        case 2: elButton.src = 'images/button_on.png'; break;
    }
}

function drawPlayhead(xindex) {
    var lastIndex = (xindex + displayLoopLength - 1) % displayLoopLength;
    
    var elNew = document.getElementById('LED_' + xindex);
    var elOld = document.getElementById('LED_' + lastIndex);
    
    elNew.src = 'images/LED_on.png';
    elOld.src = 'images/LED_off.png';
}

</script>
</head>


<!-- Preload some important UI elements -->
<img class="preload" src='images/btn_play.png'>
<img class="preload" src='images/btn_load.png'>
<img class="preload" src='images/btn_reset.png'>
<img class="preload" src='images/btn_save.png'>
<img class="preload" src='images/button_off.png'>
<img class="preload" src='images/button_half.png'>
<img class="preload" src='images/button_on.png'>
<img class="preload" src='images/LED_on.png'>

<!--  The markup below keeps all images in a row on a single long line to avoid 
            a bizarre bug where otherwise the browser inserts an extra pixel between 
            the images.  The cost of perfectionism :O{
-->

<body id='body'>
    <div id='title'>
        WebAudio Mbira Machine <span id='version'>1.0</span>
    </div>

    <section class='container active' id='pad'>    
        <div class='buttons_row' id='LED_row'>
            <span class='label'></span>
            <img id='LED_0' src='images/LED_off.png'><img id='LED_1' src='images/LED_off.png'><img id='LED_2' src='images/LED_off.png'><img id='LED_3' src='images/LED_off.png'><img id='LED_4' src='images/LED_off.png'><img id='LED_5' src='images/LED_off.png'><img id='LED_6' src='images/LED_off.png'><img id='LED_7' src='images/LED_off.png'><img id='LED_8' src='images/LED_off.png'><img id='LED_9' src='images/LED_off.png'><img id='LED_10' src='images/LED_off.png'><img id='LED_11' src='images/LED_off.png'>
        </div>
    </section>
    
    <section class='container active' id='params'>
        <div id='paramsleft_container'>
            <div id='beatcombo_container'>
                <span class='label' id='beatlabel'>Beat</span>
                <div class='combo' id='beatcombo'>
                    <span id='beatname'></span>
                    <img src='images/drop_arrow.png'>
                    <ul class='combolist' id='beatlist'>
                    </ul>
                </div>
            </div>
            <div id='kitcombo_container'>
                <span class='label' id='kitlabel'>Kit</span>
                <div class='combo' id='kitcombo'>
                    <span id='kitname'></span>
                    <img src='images/drop_arrow.png'>
                    <ul class='combolist' id='kitlist'>
                    </ul>
                </div>
            </div>
            <div id='effectcombo_container'>
                <span class='label' id='effectlabel'>Effect</span>
                <div class='combo' id='effectcombo'>
                    <span id='effectname'></span>
                    <img src='images/drop_arrow.png'>
                    <ul class='combolist' id='effectlist'>
                    </ul>
                </div>
            </div>
            <div id='tempo_container'>
                <span class='label' id='tempolabel'>Tempo</span>
                <div id='tempodisplay'>
                <span id='tempo'></span>&nbsp;<span id='bpm'>bpm</span>
                </div>
                <img id='tempodec' src='images/tempo_dec.png'><img id='tempoinc' src='images/tempo_inc.png'>
            </div>           
        </div>
        <div class='vrule'></div>
        <div class='slider_container' id='effect_container'>
            <div class='slider_groove'>
                <img class='slider_track' src='images/slider_track.png'>
                <img class='slider_thumb' id='effect_thumb' src='images/slider_thumb.png'>
            </div>
            <div class='slider_label'>
                Effect Level
            </div>
        </div>
        <div class='vrule'></div>
        <div class='slider_container' id='pitch_container'>
            <div class='slider_groove'>
                <img class='slider_track' src='images/slider_track.png'>
                <img class='slider_thumb' id='pitch_thumb' src='images/slider_thumb.png'>
            </div>
            <div class='slider_label'>
                Pitch
            </div>
        </div>
        <div class='vrule'></div>
        <div class='slider_container' id='swing_container'>
            <div class='slider_groove'>
                <img class='slider_track' src='images/slider_track.png'>
                <img class='slider_thumb' id='swing_thumb' src='images/slider_thumb.png'>
            </div>
            <div class='slider_label'>
                Swing
            </div>
        </div>
    </section>
    
    <section class='container active' id='tools'>
        <span class='label' id='beatlabel'>Beat</span>
        <img id='play' src='images/btn_play_loading.gif' width='80' height='33'>
        <img id='stop' src='images/btn_stop.png'>
        <img id='save' src='images/btn_save.png'><img id='load' src='images/btn_load.png'><img id='reset' src='images/btn_reset.png'>        
    </section>
    
    
    <div class='container' id='save_container'>
        <h3>
            Save a Beat
        </h3>
        <p>
            For security reasons, web browsers don't make it easy to save files directly to your hard drive.
            But to save your beat just copy and paste the data block below into a text file.
            To load the beat later click the Load button then paste the data block from your text file 
            into the blank window.
        </p>
        <textarea id='save_textarea' spellcheck='false'></textarea>
        <img id='save_ok' src='images/btn_ok.png'>
    </div>
    
    <div class='container' id='load_container'>
        <h3>
            Load a Beat
        </h3>
        <p>
            Paste the beat data into the blank window below and click OK.
        </p>
        <textarea id='load_textarea' spellcheck='false'></textarea>
        <div id='load_buttons'>
            <img id='load_ok' src='images/btn_ok.png'>
            <img id='load_cancel' src='images/btn_cancel.png'>
        </div>
    </div>
</body>
</html>
